<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEM Agent Console - GraphQL + Data Affinity Integration</title>
    
    <!-- Core Libraries -->
    <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
    
    <!-- GraphQL Client -->
    <script src="https://unpkg.com/@apollo/client@3.8.0/apollo-client.min.js"></script>
    <script src="https://unpkg.com/graphql@16.8.0/index.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e, #2a2a3e);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .console-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-title {
            font-size: 1.2em;
            font-weight: 600;
            background: linear-gradient(45deg, #64b5f6, #81c784);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-indicators {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: connectionPulse 2s infinite;
        }

        .connected { background: #4CAF50; }
        .disconnected { background: #F44336; }
        .pending { background: #FF9800; }

        @keyframes connectionPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            position: relative;
        }

        /* Cytoscape Graph Container */
        #cytoscapeView {
            flex: 1;
            background: radial-gradient(circle at center, #1a1a2e, #16213e);
            position: relative;
        }

        /* Data Affinity Panel */
        .affinity-panel {
            width: 350px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #64b5f6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .affinity-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .affinity-type {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .affinity-type:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .affinity-type.selected {
            background: linear-gradient(45deg, rgba(100, 181, 246, 0.2), rgba(129, 199, 132, 0.2));
            border-color: #64b5f6;
        }

        .affinity-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #64b5f6;
            border-radius: 3px;
            position: relative;
        }

        .affinity-checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            top: -2px;
            left: 1px;
            color: #64b5f6;
            font-size: 12px;
        }

        .affinity-label {
            flex: 1;
            font-size: 0.9em;
        }

        .affinity-description {
            font-size: 0.75em;
            color: #9E9E9E;
            margin-top: 4px;
        }

        .execute-btn {
            background: linear-gradient(45deg, #64b5f6, #81c784);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s ease;
            margin-top: 15px;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
        }

        .execute-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .result-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .result-type {
            font-weight: 600;
            color: #81c784;
            font-size: 0.9em;
        }

        .result-value {
            font-size: 1.1em;
            color: #ffffff;
            margin-top: 4px;
        }

        .result-meta {
            font-size: 0.75em;
            color: #9E9E9E;
            margin-top: 2px;
        }

        /* Node Information Panel */
        .node-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .node-id {
            font-weight: 600;
            color: #64b5f6;
            margin-bottom: 8px;
        }

        .node-properties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
        }

        .property {
            display: flex;
            justify-content: space-between;
        }

        .property-label {
            color: #9E9E9E;
        }

        .property-value {
            color: #ffffff;
            font-weight: 500;
        }

        /* Loading Indicator */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #9E9E9E;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #64b5f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pulse Indicators */
        .pulse-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .bid-pulse { background: #2196F3; }
        .occupancy-pulse { background: #4CAF50; }
        .compliancy-pulse { background: #FF9800; }
        .fit-pulse { background: #9C27B0; }
        .investment-pulse { background: #00BCD4; }
        .decay-pulse { background: #9E9E9E; }
        .reject-pulse { background: #F44336; }

        /* Error Messages */
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        /* Success Messages */
        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        .info-message {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="console-header">
        <div class="console-title">ðŸŽ¯ BEM Agent Console - GraphQL + Data Affinity</div>
        <div class="connection-indicators">
            <div class="connection-status">
                <div id="graphqlDot" class="connection-dot disconnected"></div>
                GraphQL Server
            </div>
            <div class="connection-status">
                <div id="websocketDot" class="connection-dot disconnected"></div>
                WebSocket
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Main Cytoscape Graph View -->
        <div id="cytoscapeView"></div>
        
        <!-- Data Affinity Control Panel -->
        <div class="affinity-panel">
            <!-- Selected Node Information -->
            <div class="panel-section">
                <div class="panel-title">ðŸŽ¯ Selected Node</div>
                <div id="nodeInfo" class="node-info">
                    <div style="text-align: center; color: #9E9E9E; font-size: 0.9em;">
                        Click a node to view details
                    </div>
                </div>
            </div>

            <!-- Data Affinity Controls -->
            <div class="panel-section">
                <div class="panel-title">ðŸ”§ Data Affinity Types</div>
                <div class="affinity-controls">
                    <div class="affinity-type" data-type="structural">
                        <div class="affinity-checkbox"></div>
                        <div>
                            <div class="affinity-label">Structural</div>
                            <div class="affinity-description">Load calculations, safety factors</div>
                        </div>
                    </div>
                    <div class="affinity-type" data-type="cost">
                        <div class="affinity-checkbox"></div>
                        <div>
                            <div class="affinity-label">Cost</div>
                            <div class="affinity-description">Material costs, labor estimation</div>
                        </div>
                    </div>
                    <div class="affinity-type" data-type="energy">
                        <div class="affinity-checkbox"></div>
                        <div>
                            <div class="affinity-label">Energy</div>
                            <div class="affinity-description">HVAC loads, efficiency</div>
                        </div>
                    </div>
                    <div class="affinity-type" data-type="mep">
                        <div class="affinity-checkbox"></div>
                        <div>
                            <div class="affinity-label">MEP</div>
                            <div class="affinity-description">Mechanical, electrical, plumbing</div>
                        </div>
                    </div>
                    <div class="affinity-type" data-type="spatial">
                        <div class="affinity-checkbox"></div>
                        <div>
                            <div class="affinity-label">Spatial</div>
                            <div class="affinity-description">Geometric transformations</div>
                        </div>
                    </div>
                    <div class="affinity-type" data-type="time">
                        <div class="affinity-checkbox"></div>
                        <div>
                            <div class="affinity-label">Time</div>
                            <div class="affinity-description">Scheduling, sequencing</div>
                        </div>
                    </div>
                </div>
                
                <button id="executeAffinity" class="execute-btn" disabled>
                    Execute Data Affinity Analysis
                </button>
            </div>

            <!-- Results Section -->
            <div class="panel-section">
                <div class="panel-title">ðŸ“Š Analysis Results</div>
                <div id="resultsContainer">
                    <div style="text-align: center; color: #9E9E9E; font-size: 0.9em;">
                        Select node and affinity types to see results
                    </div>
                </div>
            </div>

            <!-- Live Pulse Events -->
            <div class="panel-section">
                <div class="panel-title">âš¡ Live Pulse Events</div>
                <div id="pulseEvents">
                    <div class="pulse-indicator">
                        <div class="pulse-dot bid-pulse"></div>
                        Bid Pulse: Connecting...
                    </div>
                    <div class="pulse-indicator">
                        <div class="pulse-dot occupancy-pulse"></div>
                        Occupancy Pulse: Connecting...
                    </div>
                    <div class="pulse-indicator">
                        <div class="pulse-dot compliancy-pulse"></div>
                        Compliancy Pulse: Connecting...
                    </div>
                    <div class="pulse-indicator">
                        <div class="pulse-dot investment-pulse"></div>
                        Investment Pulse: Connecting...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let cy;
        let selectedNode = null;
        let selectedAffinityTypes = new Set();
        let graphqlEndpoint = 'http://localhost:8000/graphql';
        let websocketEndpoint = 'ws://localhost:8000/ws/cytoscape';
        let websocket = null;

        // GraphQL Queries and Mutations
        const GRAPH_QUERY = `
            query LoadCytoscapeGraph($filter: NodeFilter) {
                graph(filter: $filter) {
                    nodes {
                        id
                        type
                        phase
                        primaryFunctor
                        secondaryFunctor
                        position {
                            x
                            y
                        }
                        coefficients {
                            structural
                            cost
                            energy
                            mep
                            fabrication
                            time
                        }
                        properties {
                            material
                            dimensions
                            specifications
                        }
                        status
                    }
                    edges {
                        id
                        source
                        target
                        relationshipType
                        weight
                        properties
                    }
                    metadata
                }
            }
        `;

        const AFFINITY_CONFIGURATION_QUERY = `
            query GetAffinityConfiguration {
                affinityConfiguration {
                    functorTypes {
                        name
                        dataAffinity
                        includedFunctors
                    }
                    availableAffinityTypes
                }
            }
        `;

        const EXECUTE_DATA_AFFINITY_MUTATION = `
            mutation ExecuteDataAffinity($request: AffinityRequest!) {
                executeDataAffinity(request: $request) {
                    structuralAffinity {
                        affinityType
                        executionStatus
                        formulasExecuted
                        componentId
                        calculationResults
                    }
                    costAffinity {
                        affinityType
                        executionStatus
                        formulasExecuted
                        componentId
                        calculationResults
                    }
                    energyAffinity {
                        affinityType
                        executionStatus
                        formulasExecuted
                        componentId
                        calculationResults
                    }
                    mepAffinity {
                        affinityType
                        executionStatus
                        formulasExecuted
                        componentId
                        calculationResults
                    }
                    spatialAffinity {
                        affinityType
                        executionStatus
                        formulasExecuted
                        componentId
                        calculationResults
                    }
                    timeAffinity {
                        affinityType
                        executionStatus
                        formulasExecuted
                        componentId
                        calculationResults
                    }
                }
            }
        `;

        const PULSE_EVENTS_SUBSCRIPTION = `
            subscription LivePulseEvents {
                pulseEvents {
                    id
                    pulseType
                    sourceNode
                    targetNode
                    timestamp
                    status
                    data
                }
            }
        `;

        // GraphQL Client Functions
        async function executeGraphQLQuery(query, variables = {}) {
            try {
                const response = await fetch(graphqlEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: variables
                    })
                });

                const result = await response.json();
                
                if (result.errors) {
                    console.error('GraphQL errors:', result.errors);
                    throw new Error(result.errors[0].message);
                }

                return result.data;
            } catch (error) {
                console.error('GraphQL request failed:', error);
                updateConnectionStatus('graphql', false);
                throw error;
            }
        }

        // Initialize Application
        async function initializeApp() {
            console.log('ðŸš€ Initializing BEM Agent Console with GraphQL Integration');
            
            // Test GraphQL connection
            await testGraphQLConnection();
            
            // Setup WebSocket connection
            setupWebSocketConnection();
            
            // Initialize Cytoscape
            await initializeCytoscape();
            
            // Setup event handlers
            setupEventHandlers();
            
            // Load initial data
            await loadGraphData();
        }

        async function testGraphQLConnection() {
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    updateConnectionStatus('graphql', true);
                    console.log('âœ… GraphQL server connected');
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                console.error('âŒ GraphQL server connection failed:', error);
                updateConnectionStatus('graphql', false);
                
                // Show fallback message
                showMessage('GraphQL server not available. Using demo data.', 'error');
                await initializeDemoData();
            }
        }

        function setupWebSocketConnection() {
            try {
                websocket = new WebSocket(websocketEndpoint);
                
                websocket.onopen = () => {
                    console.log('âœ… WebSocket connected');
                    updateConnectionStatus('websocket', true);
                };
                
                websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleRealtimeUpdate(data);
                    } catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('âŒ WebSocket error:', error);
                    updateConnectionStatus('websocket', false);
                };
                
                websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus('websocket', false);
                    
                    // Try to reconnect after 5 seconds
                    setTimeout(setupWebSocketConnection, 5000);
                };
            } catch (error) {
                console.error('Failed to setup WebSocket:', error);
                updateConnectionStatus('websocket', false);
            }
        }

        async function initializeCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cytoscapeView'),
                
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#64b5f6',
                            'label': 'data(label)',
                            'color': '#ffffff',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'width': 40,
                            'height': 40,
                            'border-width': 2,
                            'border-color': '#ffffff'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-color': '#81c784',
                            'border-width': 4,
                            'background-color': '#81c784'
                        }
                    },
                    {
                        selector: 'node[type="structural"]',
                        style: { 'background-color': '#2196F3' }
                    },
                    {
                        selector: 'node[type="cost"]',
                        style: { 'background-color': '#4CAF50' }
                    },
                    {
                        selector: 'node[type="energy"]',
                        style: { 'background-color': '#FF9800' }
                    },
                    {
                        selector: 'node[type="mep"]',
                        style: { 'background-color': '#9C27B0' }
                    },
                    {
                        selector: 'node[type="fabrication"]',
                        style: { 'background-color': '#00BCD4' }
                    },
                    {
                        selector: 'node[type="time"]',
                        style: { 'background-color': '#9E9E9E' }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': 'rgba(255, 255, 255, 0.6)',
                            'target-arrow-color': 'rgba(255, 255, 255, 0.6)',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.2
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'line-color': '#81c784',
                            'target-arrow-color': '#81c784',
                            'width': 4
                        }
                    }
                ],
                
                layout: {
                    name: 'circle',
                    radius: 200,
                    animate: true,
                    animationDuration: 1000
                }
            });

            // Add node click handler
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                selectNode(node);
            });

            // Add background click handler to deselect
            cy.on('tap', function(evt) {
                if (evt.target === cy) {
                    deselectNode();
                }
            });
        }

        async function loadGraphData() {
            try {
                console.log('ðŸ“Š Loading graph data from GraphQL...');
                
                const data = await executeGraphQLQuery(GRAPH_QUERY);
                const graph = data.graph;
                
                if (graph && graph.nodes && graph.edges) {
                    const elements = convertGraphQLToCytoscape(graph);
                    cy.elements().remove();
                    cy.add(elements);
                    cy.layout({ name: 'circle', radius: 200, animate: true }).run();
                    
                    console.log(`âœ… Loaded ${graph.nodes.length} nodes and ${graph.edges.length} edges`);
                } else {
                    throw new Error('Invalid graph data received');
                }
                
            } catch (error) {
                console.error('Failed to load graph data:', error);
                showMessage('Failed to load graph data. Using demo data.', 'error');
                await initializeDemoData();
            }
        }

        function convertGraphQLToCytoscape(graph) {
            const elements = [];
            
            // Convert nodes
            graph.nodes.forEach(node => {
                elements.push({
                    data: {
                        id: node.id,
                        label: node.id.substring(0, 8) + '...',
                        type: node.type,
                        phase: node.phase,
                        primaryFunctor: node.primaryFunctor,
                        secondaryFunctor: node.secondaryFunctor,
                        coefficients: node.coefficients,
                        properties: node.properties,
                        status: node.status
                    },
                    position: node.position || { x: Math.random() * 400, y: Math.random() * 400 }
                });
            });
            
            // Convert edges
            graph.edges.forEach(edge => {
                elements.push({
                    data: {
                        id: edge.id,
                        source: edge.source,
                        target: edge.target,
                        type: edge.relationshipType,
                        weight: edge.weight,
                        properties: edge.properties
                    }
                });
            });
            
            return elements;
        }

        async function initializeDemoData() {
            // Fallback demo data when GraphQL is not available
            const demoElements = [
                { data: { id: 'n1', label: 'Structural-1', type: 'structural' }, position: { x: 100, y: 100 } },
                { data: { id: 'n2', label: 'Cost-1', type: 'cost' }, position: { x: 200, y: 100 } },
                { data: { id: 'n3', label: 'Energy-1', type: 'energy' }, position: { x: 150, y: 200 } },
                { data: { id: 'n4', label: 'MEP-1', type: 'mep' }, position: { x: 250, y: 200 } },
                { data: { id: 'e1', source: 'n1', target: 'n2' } },
                { data: { id: 'e2', source: 'n2', target: 'n3' } },
                { data: { id: 'e3', source: 'n3', target: 'n4' } },
                { data: { id: 'e4', source: 'n4', target: 'n1' } }
            ];
            
            cy.elements().remove();
            cy.add(demoElements);
            cy.layout({ name: 'circle', radius: 150, animate: true }).run();
        }

        function setupEventHandlers() {
            // Affinity type selection
            document.querySelectorAll('.affinity-type').forEach(element => {
                element.addEventListener('click', () => {
                    toggleAffinityType(element);
                });
            });

            // Execute affinity button
            document.getElementById('executeAffinity').addEventListener('click', () => {
                executeDataAffinity();
            });
        }

        function selectNode(node) {
            selectedNode = node;
            
            // Update UI
            cy.elements().removeClass('selected');
            node.addClass('selected');
            
            // Update node info panel
            updateNodeInfoPanel(node);
            
            // Enable execute button if affinity types are selected
            updateExecuteButton();
        }

        function deselectNode() {
            selectedNode = null;
            cy.elements().removeClass('selected');
            
            // Clear node info panel
            document.getElementById('nodeInfo').innerHTML = `
                <div style="text-align: center; color: #9E9E9E; font-size: 0.9em;">
                    Click a node to view details
                </div>
            `;
            
            // Disable execute button
            updateExecuteButton();
        }

        function updateNodeInfoPanel(node) {
            const data = node.data();
            const coefficients = data.coefficients || {};
            const properties = data.properties || {};
            
            document.getElementById('nodeInfo').innerHTML = `
                <div class="node-id">Node: ${data.id}</div>
                <div class="node-properties">
                    <div class="property">
                        <span class="property-label">Type:</span>
                        <span class="property-value">${data.type || 'N/A'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">Phase:</span>
                        <span class="property-value">${data.phase || 'N/A'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">Primary:</span>
                        <span class="property-value">${data.primaryFunctor || 'N/A'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">Status:</span>
                        <span class="property-value">${data.status || 'active'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">Structural:</span>
                        <span class="property-value">${coefficients.structural || '0.0'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">Cost:</span>
                        <span class="property-value">${coefficients.cost || '0.0'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">Energy:</span>
                        <span class="property-value">${coefficients.energy || '0.0'}</span>
                    </div>
                    <div class="property">
                        <span class="property-label">MEP:</span>
                        <span class="property-value">${coefficients.mep || '0.0'}</span>
                    </div>
                </div>
            `;
        }

        function toggleAffinityType(element) {
            const type = element.dataset.type;
            const checkbox = element.querySelector('.affinity-checkbox');
            
            if (selectedAffinityTypes.has(type)) {
                selectedAffinityTypes.delete(type);
                element.classList.remove('selected');
                checkbox.classList.remove('checked');
            } else {
                selectedAffinityTypes.add(type);
                element.classList.add('selected');
                checkbox.classList.add('checked');
            }
            
            updateExecuteButton();
        }

        function updateExecuteButton() {
            const button = document.getElementById('executeAffinity');
            const canExecute = selectedNode && selectedAffinityTypes.size > 0;
            
            button.disabled = !canExecute;
            
            if (canExecute) {
                button.textContent = `Execute Analysis (${selectedAffinityTypes.size} types)`;
            } else {
                button.textContent = 'Select node and affinity types';
            }
        }

        async function executeDataAffinity() {
            if (!selectedNode || selectedAffinityTypes.size === 0) {
                return;
            }

            const button = document.getElementById('executeAffinity');
            const originalText = button.textContent;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '<div class="spinner" style="margin: 0 auto;"></div>';
                
                showMessage('Executing data affinity analysis...', 'info');
                
                const nodeData = selectedNode.data();
                const affinityTypes = Array.from(selectedAffinityTypes);
                
                // Prepare request parameters
                const parameters = {
                    volume_cm3: 1000.0,
                    area_m2: 10.0,
                    length_mm: 2000.0
                };
                
                // Execute GraphQL mutation
                const result = await executeGraphQLQuery(EXECUTE_DATA_AFFINITY_MUTATION, {
                    request: {
                        componentId: nodeData.id,
                        affinityTypes: affinityTypes,
                        executionMode: "symbolic_reasoning",
                        parameters: parameters
                    }
                });
                
                // Display results
                displayAffinityResults(result.executeDataAffinity, affinityTypes);
                showMessage('Data affinity analysis completed successfully!', 'success');
                
            } catch (error) {
                console.error('Data affinity execution failed:', error);
                showMessage(`Analysis failed: ${error.message}`, 'error');
                
                // Show demo results as fallback
                displayDemoResults(Array.from(selectedAffinityTypes));
                
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        function displayAffinityResults(results, requestedTypes) {
            const container = document.getElementById('resultsContainer');
            let html = '';
            
            requestedTypes.forEach(type => {
                const affinityKey = type + 'Affinity';
                const result = results[affinityKey];
                
                if (result && result.executionStatus === 'completed') {
                    html += `
                        <div class="result-item">
                            <div class="result-type">${type.toUpperCase()} Affinity</div>
                            <div class="result-value">Status: ${result.executionStatus}</div>
                            <div class="result-meta">
                                ${result.formulasExecuted} formulas executed
                                Component: ${result.componentId}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="result-item">
                            <div class="result-type">${type.toUpperCase()} Affinity</div>
                            <div class="result-value">No data available</div>
                            <div class="result-meta">Check microservice connectivity</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<div style="text-align: center; color: #9E9E9E;">No results to display</div>';
        }

        function displayDemoResults(affinityTypes) {
            const container = document.getElementById('resultsContainer');
            let html = '';
            
            const demoValues = {
                structural: { value: '2,500 kN', description: 'Load capacity' },
                cost: { value: '$125,000', description: 'Total estimated cost' },
                energy: { value: '85%', description: 'Efficiency rating' },
                mep: { value: '12.5 kW', description: 'Power requirement' },
                spatial: { value: '156 mÂ³', description: 'Volume calculated' },
                time: { value: '14 days', description: 'Estimated duration' }
            };
            
            affinityTypes.forEach(type => {
                const demo = demoValues[type];
                if (demo) {
                    html += `
                        <div class="result-item">
                            <div class="result-type">${type.toUpperCase()} Affinity (Demo)</div>
                            <div class="result-value">${demo.value}</div>
                            <div class="result-meta">${demo.description}</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function handleRealtimeUpdate(data) {
            console.log('Real-time update received:', data);
            
            // Handle different types of real-time updates
            if (data.type === 'pulse_event') {
                updatePulseIndicators(data);
            } else if (data.type === 'node_update') {
                updateNodeInGraph(data);
            } else if (data.type === 'graph_update') {
                refreshGraphData();
            }
        }

        function updatePulseIndicators(pulseData) {
            // Update pulse indicators based on real-time data
            const pulseEvents = document.getElementById('pulseEvents');
            const timestamp = new Date().toLocaleTimeString();
            
            // You could update specific pulse indicators here
            console.log(`Pulse update at ${timestamp}:`, pulseData);
        }

        function updateNodeInGraph(nodeData) {
            // Update specific node in the graph
            const node = cy.getElementById(nodeData.nodeId);
            if (node.length > 0) {
                // Update node data
                node.data(nodeData.updates);
                console.log('Node updated in graph:', nodeData.nodeId);
            }
        }

        async function refreshGraphData() {
            // Refresh the entire graph
            console.log('Refreshing graph data...');
            await loadGraphData();
        }

        function updateConnectionStatus(type, connected) {
            const dotId = type === 'graphql' ? 'graphqlDot' : 'websocketDot';
            const dot = document.getElementById(dotId);
            
            if (dot) {
                dot.className = `connection-dot ${connected ? 'connected' : 'disconnected'}`;
            }
        }

        function showMessage(message, type = 'info') {
            // Create or update message display
            let messageDiv = document.getElementById('messageDisplay');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'messageDisplay';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '80px';
                messageDiv.style.right = '20px';
                messageDiv.style.zIndex = '9999';
                messageDiv.style.maxWidth = '300px';
                document.body.appendChild(messageDiv);
            }
            
            const className = type === 'error' ? 'error-message' : 
                             type === 'success' ? 'success-message' : 'info-message';
            
            messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (messageDiv) {
                    messageDiv.innerHTML = '';
                }
            }, 5000);
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>
</html> 