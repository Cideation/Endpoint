# Render.com Platform Configuration
# BEM System - Multi-Platform Deployment
# Platforms: AA + ECM + Cytoscape UI + PostgreSQL on Render

version: '3.8'

# Render Platform Services Configuration
# Deploy with: render-cli deploy

services:
  # Automated Admin (AA) - Behavior Classification Service
  automated-admin:
    type: web-service
    name: bem-automated-admin
    runtime: python3
    buildCommand: pip install -r requirements.txt
    startCommand: python frontend/behavior_driven_ac.py
    plan: starter # or standard for production
    region: oregon # or closest to your users
    environment:
      - PORT=8003
      - DATABASE_URL=${{DATABASE_URL}}
      - ENVIRONMENT=production
    healthCheckPath: /behavior_analytics
    autoDeploy: true
    branch: main
    scaling:
      minInstances: 1
      maxInstances: 3
    # Environment variables from Render dashboard:
    # DATABASE_URL - Auto-generated by PostgreSQL add-on
    
  # ECM (Environmental Computation Matrix) - WebSocket Infrastructure  
  ecm-gateway:
    type: web-service
    name: bem-ecm-gateway
    runtime: python3
    buildCommand: pip install -r requirements.txt
    startCommand: python start_services.py websockets
    plan: standard # Always-on requirement
    region: oregon
    environment:
      - ECM_PORT=8765
      - PULSE_PORT=8766
      - DATABASE_URL=${{DATABASE_URL}}
      - WEBSOCKET_TIMEOUT=300
    healthCheckPath: /health
    autoDeploy: true
    branch: main
    scaling:
      minInstances: 1 # Always-on solid backend pipe
      maxInstances: 2
    # WebSocket support enabled in Render dashboard
    
  # Cytoscape.js UI - Agent Console & Graph Visualization
  cytoscape-ui:
    type: static-site
    name: bem-cytoscape-ui
    buildCommand: |
      mkdir -p build
      cp frontend/dynamic_ac_interface.html build/index.html
      cp frontend/agent_console.html build/
      cp frontend/realtime_viewer.html build/
      cp -r frontend/static/* build/ 2>/dev/null || true
    publishPath: build
    pullRequestPreviewsEnabled: true
    autoDeploy: true
    branch: main
    customHeaders:
      # CORS for WebSocket connections
      - path: /*
        headers:
          X-Frame-Options: DENY
          X-Content-Type-Options: nosniff
          Referrer-Policy: strict-origin-when-cross-origin
    routes:
      - type: rewrite
        source: /api/*
        destination: https://bem-automated-admin.onrender.com/$1
      - type: rewrite  
        source: /ws/*
        destination: https://bem-ecm-gateway.onrender.com/$1
    # Environment variables injected at build time:
    # API_URL=https://bem-automated-admin.onrender.com
    # ECM_WEBSOCKET_URL=wss://bem-ecm-gateway.onrender.com

  # PostgreSQL Database - Primary Data Store
  postgresql:
    type: postgres
    name: bem-postgresql
    plan: starter # or standard for production
    region: oregon
    version: "13"
    # Automatically provides DATABASE_URL to other services
    
# Additional Render Configuration Files

# render.yaml (root level)
databases:
  - name: bem-postgresql
    databaseName: bem_production
    user: bem_user
    plan: starter
    region: oregon

services:
  - type: web
    name: bem-automated-admin
    env: python
    repo: https://github.com/Cideation/Endpoint.git
    buildCommand: pip install -r requirements.txt
    startCommand: python frontend/behavior_driven_ac.py
    plan: starter
    autoDeploy: false
    envVars:
      - key: PORT
        value: 8003
      - key: DATABASE_URL
        fromDatabase:
          name: bem-postgresql
          property: connectionString
          
  - type: web
    name: bem-ecm-gateway  
    env: python
    repo: https://github.com/Cideation/Endpoint.git
    buildCommand: pip install -r requirements.txt
    startCommand: python start_services.py websockets
    plan: standard
    autoDeploy: false
    envVars:
      - key: ECM_PORT
        value: 8765
      - key: PULSE_PORT  
        value: 8766
      - key: DATABASE_URL
        fromDatabase:
          name: bem-postgresql
          property: connectionString
          
  - type: static
    name: bem-cytoscape-ui
    repo: https://github.com/Cideation/Endpoint.git
    buildCommand: |
      mkdir -p build
      cp frontend/dynamic_ac_interface.html build/index.html
      cp frontend/agent_console.html build/
      cp frontend/realtime_viewer.html build/
    publishPath: build
    pullRequestPreviewsEnabled: true
    autoDeploy: false
    routes:
      - type: rewrite
        source: /api/*
        destination: https://bem-automated-admin.onrender.com/api/*
      - type: rewrite
        source: /ws/*  
        destination: https://bem-ecm-gateway.onrender.com/ws/*

# Render Deployment Commands:
# 1. Connect GitHub repository to Render
# 2. Create PostgreSQL database first
# 3. Deploy services in order: AA → ECM → UI
# 4. Configure environment variables in Render dashboard
# 5. Enable auto-deploy for continuous deployment

# Cost Estimation (Starter Plans):
# - PostgreSQL: $7/month
# - AA Service: $7/month  
# - ECM Gateway: $25/month (Standard for always-on)
# - Static Site: Free
# Total: ~$39/month 